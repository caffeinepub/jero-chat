{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Presence last-seen + improved online/offline indicators (frontend)",
  "requirements": [
    {
      "id": "REQ-59",
      "summary": "Update React Query presence fetching to use a combined presence+last-seen payload and consume it consistently across chat header, conversations list, and contacts list with polling.",
      "acceptanceCriteria": [
        "A new/updated React Query hook exists to retrieve a contact’s presence state plus last-seen time from the backend.",
        "The chat header (ChatThread) uses the new presence payload and no longer relies on hardcoded or partial presence data.",
        "ConversationsList and ContactsPanel items use the new presence payload consistently for the same contact.",
        "Presence polling remains enabled (refresh-based updates are acceptable), and the UI updates within the existing polling interval without requiring real-time sockets."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Replace/extend the presence query layer to return a combined payload (isOnline + lastSeen timestamp) rather than a bare boolean, using the backend presence capability that returns presence plus a timestamp; keep polling enabled and ensure query keys are consistent to avoid duplicated inconsistent presence results across different lists."
        },
        {
          "path": "frontend/src/components/chat/ChatThread.tsx",
          "operation": "modify",
          "description": "Switch chat header presence consumption from the boolean-only hook to the new combined presence payload, using a single derived presence source for the selected contact so the header stays consistent with list views during polling refreshes."
        },
        {
          "path": "frontend/src/components/conversations/ConversationsList.tsx",
          "operation": "modify",
          "description": "Update conversation items to use the new combined presence payload (isOnline + lastSeen) instead of the boolean-only presence hook so list indicators/text stay consistent with the chat header and contacts list."
        },
        {
          "path": "frontend/src/components/contacts/ContactsPanel.tsx",
          "operation": "modify",
          "description": "Update contact items to use the new combined presence payload (isOnline + lastSeen) instead of the boolean-only presence hook so list indicators/text stay consistent with the chat header and conversations list."
        }
      ]
    },
    {
      "id": "REQ-60",
      "summary": "Implement presence UI: always show green/grey dot, and show human-readable last-seen text when offline with fallback states in English.",
      "acceptanceCriteria": [
        "In the chat header, a presence dot is always shown: green when online, grey when offline (do not hide the indicator when offline).",
        "In ConversationsList and ContactsPanel, a presence dot is always shown: green when online, grey when offline.",
        "When offline and a last-seen timestamp is available, the UI displays English text in the form “Last seen HH:MM” (or equivalent concise English) using a consistent locale/format across the app.",
        "When offline and last-seen is not available, the UI displays “Offline” (English).",
        "When presence info is still loading or unavailable, the UI displays a clear English fallback such as “Status unavailable”, and the dot does not incorrectly show green (online)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/utils/formatLastSeen.ts",
          "operation": "create",
          "description": "Add a small utility to convert the backend-provided timestamp into a consistent English \"Last seen HH:MM\" string (using a single chosen locale/format across the app) and to gracefully handle unknown/unset timestamps."
        },
        {
          "path": "frontend/src/components/presence/PresenceDot.tsx",
          "operation": "create",
          "description": "Create a reusable presence dot component that always renders (green when online, grey when offline/unknown) to ensure consistent indicator behavior across ChatThread, ConversationsList, and ContactsPanel."
        },
        {
          "path": "frontend/src/components/presence/PresenceStatusText.tsx",
          "operation": "create",
          "description": "Create a small reusable status text component/helper that displays: \"Online\" when online, \"Last seen HH:MM\" when offline with a known timestamp, \"Offline\" when offline without timestamp, and \"Status unavailable\" when loading/unavailable; keep all user-facing text in English."
        },
        {
          "path": "frontend/src/components/chat/ChatThread.tsx",
          "operation": "modify",
          "description": "Update the chat header UI to always show the presence dot (green/grey) and display the correct English status text using the combined presence payload; ensure that loading/unavailable presence never shows a green (online) dot and instead shows the fallback text."
        },
        {
          "path": "frontend/src/components/conversations/ConversationsList.tsx",
          "operation": "modify",
          "description": "Update conversation row UI so the presence dot is always visible (green when online, grey when offline/unknown) and the status line uses the consistent English rules for online/offline/last-seen/unavailable."
        },
        {
          "path": "frontend/src/components/contacts/ContactsPanel.tsx",
          "operation": "modify",
          "description": "Update contact row UI so the presence dot is always visible (green when online, grey when offline/unknown) and the right-side/secondary status text uses the consistent English rules for online/offline/last-seen/unavailable."
        }
      ]
    }
  ]
}